@using MudBlazor
@using Microsoft.AspNetCore.Components.Web
@using Core.DTOs.Organization.Project
@using Core.DTOs.Auth.ProjectTeamMembers
@using Core.Constants
@using Web.Components.Common
@using Web.Services.Interfaces
@using Web.Services.Interfaces.Auth
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject IProjectApiService ProjectService
@inject IProjectTeamMemberApiService TeamMemberService
@inject ICurrentUserService CurrentUserService
@inject ILoggingService Logger
@implements IDisposable

<MudAppBar Elevation="0" Fixed="true" Class="ezpro-header">
    <div class="header-content">
        <div class="header-left">
            <!-- Menu Toggle Button -->
            <MudIconButton Icon="@Icons.Material.Filled.Menu" 
                           Color="Color.Inherit" 
                           Edge="Edge.Start" 
                           OnClick="@OnToggleClick"
                           Class="menu-toggle" />
            
            <!-- Search Box -->
            <MudHidden Breakpoint="Breakpoint.SmAndDown">
                <div class="search-box">
                    <MudTextField T="string"
                                  @bind-Value="SearchText"
                                  Placeholder="Buscar proyectos, tareas o miembros del equipo..."
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Class="search-input"
                                  Immediate="false"
                                  Margin="Margin.Dense" />
                </div>
            </MudHidden>
        </div>

        <MudSpacer />

        <div class="header-right">
            <!-- Mobile Search -->
            <MudHidden Breakpoint="Breakpoint.MdAndUp">
                <MudIconButton Icon="@Icons.Material.Filled.Search"
                               Color="Color.Inherit"
                               OnClick="@ToggleMobileSearch" />
            </MudHidden>

            <!-- Project Selector -->
            <MudTooltip Text="Cambiar Proyecto">
                <MudMenu AnchorOrigin="Origin.BottomCenter"
                         TransformOrigin="Origin.TopCenter"
                         Dense="true"
                         MaxHeight="400">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Text" 
                                   Color="Color.Inherit" 
                                   StartIcon="@Icons.Material.Filled.Business"
                                   EndIcon="@Icons.Material.Filled.KeyboardArrowDown"
                                   Class="project-selector-button">
                            <MudHidden Breakpoint="Breakpoint.SmAndDown">
                                <div class="d-flex flex-column align-start">
                                    <span class="project-name">@(_selectedProjectName)</span>
                                    @if (!string.IsNullOrEmpty(_userRole))
                                    {
                                        <MudText Typo="Typo.caption" Style="font-size: 0.7rem; opacity: 0.8;">
                                            @SimplifiedRoles.GetDisplayName(_userRole)
                                        </MudText>
                                    }
                                </div>
                            </MudHidden>
                        </MudButton>
                    </ActivatorContent>
                    <ChildContent>
                        <div class="pa-3" style="min-width: 350px;">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Mis Proyectos</MudText>
                        @if (_userProjects != null && _userProjects.Any())
                        {
                            <MudTextField T="string" 
                                          @bind-Value="_projectSearchText"
                                          Placeholder="Buscar proyecto..."
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          Margin="Margin.Dense"
                                          Class="mb-2" />
                            <MudDivider Class="mb-2" />
                            <div style="max-height: 300px; overflow-y: auto;">
                                @foreach (var project in FilteredUserProjects)
                                {
                                    var isActive = project.ProjectId == _selectedProjectId;
                                    var isActiveProject = _activeProject?.ProjectId == project.ProjectId;
                                    <MudMenuItem OnClick="@(() => SelectUserProject(project))" 
                                                 Icon="@(isActive ? Icons.Material.Filled.Check : Icons.Material.Filled.FolderOpen)"
                                                 IconColor="@(isActive ? Color.Primary : Color.Default)"
                                                 Class="@(isActiveProject ? "active-project-item" : "")">
                                        <div style="flex: 1;">
                                            <div class="d-flex justify-space-between align-center">
                                                <MudText Typo="Typo.body2">
                                                    @project.ProjectName
                                                    @if (isActiveProject)
                                                    {
                                                        <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" Style="margin-left: 4px;" />
                                                    }
                                                </MudText>
                                                <MudChip T="string" Size="Size.Small" Color="@GetRoleColor(project.Role)">
                                                    @SimplifiedRoles.GetDisplayName(project.Role)
                                                </MudChip>
                                            </div>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@project.ProjectCode</MudText>
                                        </div>
                                    </MudMenuItem>
                                }
                            </div>
                            @if (_userProjects.Count > 5)
                            {
                                <MudDivider Class="mt-2 mb-2" />
                                <MudButton Variant="Variant.Text" Color="Color.Primary" FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.ViewList"
                                           OnClick="@(() => Navigation.NavigateTo("/projects"))">
                                    Ver todos mis proyectos
                                </MudButton>
                            }
                        }
                        else if (_loadingProjects)
                        {
                            <div class="d-flex justify-center pa-3">
                                <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
                            </div>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="pa-3 text-center">
                                No tienes proyectos asignados
                            </MudText>
                        }
                    </div>
                    </ChildContent>
                </MudMenu>
            </MudTooltip>

            <!-- Theme Toggle -->
            <MudTooltip Text="@(IsDarkMode ? "Modo Claro" : "Modo Oscuro")">
                <MudIconButton Icon="@(IsDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                               Color="Color.Inherit"
                               OnClick="@OnThemeToggle" />
            </MudTooltip>

            <!-- Notifications -->
            <MudTooltip Text="Notificaciones">
                <MudBadge Content="@NotificationCount" 
                          Color="Color.Error" 
                          Overlap="true" 
                          Visible="@(NotificationCount > 0)"
                          Max="9"
                          Class="mx-1">
                    <MudIconButton Icon="@Icons.Material.Filled.Notifications"
                                   Color="Color.Inherit"
                                   OnClick="@OnNotificationsClick" />
                </MudBadge>
            </MudTooltip>

            <!-- Messages -->
            <MudTooltip Text="Mensajes">
                <MudBadge Content="@MessageCount" 
                          Color="Color.Primary" 
                          Overlap="true" 
                          Visible="@(MessageCount > 0)"
                          Max="9"
                          Class="mx-1">
                    <MudIconButton Icon="@Icons.Material.Filled.Email"
                                   Color="Color.Inherit"
                                   OnClick="@OnMessagesClick" />
                </MudBadge>
            </MudTooltip>

            <!-- Quick Actions -->
            <MudHidden Breakpoint="Breakpoint.SmAndDown">
                <MudTooltip Text="Acciones Rápidas">
                    <MudMenu Icon="@Icons.Material.Filled.Apps" 
                             Color="Color.Inherit"
                             AnchorOrigin="Origin.BottomCenter"
                             TransformOrigin="Origin.TopCenter"
                             Class="mx-1">
                        <div class="quick-actions-grid pa-3">
                            <MudButton Variant="Variant.Text" Color="Color.Default" Class="quick-action-item" OnClick="@(() => NavigateTo("/projects/new"))">
                                <div class="d-flex flex-column align-center gap-1">
                                    <MudIcon Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Size="Size.Large" />
                                    <MudText Typo="Typo.caption">Nuevo Proyecto</MudText>
                                </div>
                            </MudButton>
                            <MudButton Variant="Variant.Text" Color="Color.Default" Class="quick-action-item" OnClick="@(() => NavigateTo("/budgets/new"))">
                                <div class="d-flex flex-column align-center gap-1">
                                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Color="Color.Success" Size="Size.Large" />
                                    <MudText Typo="Typo.caption">Presupuesto</MudText>
                                </div>
                            </MudButton>
                            <MudButton Variant="Variant.Text" Color="Color.Default" Class="quick-action-item" OnClick="@(() => NavigateTo("/team"))">
                                <div class="d-flex flex-column align-center gap-1">
                                    <MudIcon Icon="@Icons.Material.Filled.Groups" Color="Color.Info" Size="Size.Large" />
                                    <MudText Typo="Typo.caption">Equipo</MudText>
                                </div>
                            </MudButton>
                            <MudButton Variant="Variant.Text" Color="Color.Default" Class="quick-action-item" OnClick="@(() => NavigateTo("/reports"))">
                                <div class="d-flex flex-column align-center gap-1">
                                    <MudIcon Icon="@Icons.Material.Filled.Assessment" Color="Color.Warning" Size="Size.Large" />
                                    <MudText Typo="Typo.caption">Reportes</MudText>
                                </div>
                            </MudButton>
                            <MudButton Variant="Variant.Text" Color="Color.Default" Class="quick-action-item" OnClick="@(() => NavigateTo("/schedule"))">
                                <div class="d-flex flex-column align-center gap-1">
                                    <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Secondary" Size="Size.Large" />
                                    <MudText Typo="Typo.caption">Cronograma</MudText>
                                </div>
                            </MudButton>
                            <MudButton Variant="Variant.Text" Color="Color.Default" Class="quick-action-item" OnClick="@(() => NavigateTo("/documents"))">
                                <div class="d-flex flex-column align-center gap-1">
                                    <MudIcon Icon="@Icons.Material.Filled.Folder" Color="Color.Dark" Size="Size.Large" />
                                    <MudText Typo="Typo.caption">Documentos</MudText>
                                </div>
                            </MudButton>
                        </div>
                    </MudMenu>
                </MudTooltip>
            </MudHidden>

            <!-- Full Screen Toggle -->
            <MudHidden Breakpoint="Breakpoint.SmAndDown">
                <MudTooltip Text="@(_isFullScreen ? "Salir de Pantalla Completa" : "Pantalla Completa")">
                    <MudIconButton Icon="@(_isFullScreen ? Icons.Material.Filled.FullscreenExit : Icons.Material.Filled.Fullscreen)"
                                   Color="Color.Inherit"
                                   OnClick="@ToggleFullScreen" />
                </MudTooltip>
            </MudHidden>

            <!-- User Menu -->
            <MudMenu AnchorOrigin="Origin.BottomRight" 
                     TransformOrigin="Origin.TopRight"
                     MaxHeight="400"
                     Class="user-menu">
                <ActivatorContent>
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Inherit" 
                               EndIcon="@Icons.Material.Filled.KeyboardArrowDown"
                               Class="user-menu-button">
                        <UserAvatar PhotoUrl="@UserAvatar" UserName="@UserName" Size="Size.Small" Class="me-2" />
                        <MudHidden Breakpoint="Breakpoint.SmAndDown">
                            <span class="user-name">@UserName</span>
                        </MudHidden>
                    </MudButton>
                </ActivatorContent>
                <ChildContent>
                    <div class="user-menu-header pa-4">
                        <div class="d-flex align-center gap-3">
                            <UserAvatar PhotoUrl="@UserAvatar" UserName="@UserName" Size="Size.Large" />
                            <div>
                                <MudText Typo="Typo.h6">@UserName</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Default">@UserEmail</MudText>
                            </div>
                        </div>
                    </div>
                    <MudDivider />
                    <MudMenuItem Icon="@Icons.Material.Filled.Person" OnClick="@OnProfileClick">
                        Mi Perfil
                    </MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.Dashboard" OnClick="@(() => NavigateTo("/home"))">
                        Tablero
                    </MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.Settings" OnClick="@OnSettingsClick">
                        Configuración
                    </MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.Notifications" OnClick="@(() => NavigateTo("/settings/notifications"))">
                        Preferencias de Notificación
                    </MudMenuItem>
                    <MudDivider />
                    <MudMenuItem Icon="@Icons.Material.Filled.HelpOutline" OnClick="@(() => NavigateTo("/help"))">
                        Ayuda y Soporte
                    </MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.Info" OnClick="@(() => NavigateTo("/about"))">
                        Acerca de
                    </MudMenuItem>
                    <MudDivider />
                    <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="@OnLogoutClick" Class="text-error">
                        Cerrar Sesión
                    </MudMenuItem>
                </ChildContent>
            </MudMenu>
        </div>
    </div>
    
    <!-- Mobile Search Bar -->
    <MudCollapse Expanded="_showMobileSearch">
        <div class="mobile-search-bar pa-3">
            <MudTextField T="string"
                          @bind-Value="SearchText"
                          Placeholder="Buscar..."
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          FullWidth="true"
                          Immediate="false"
                          Margin="Margin.Dense"
                          OnKeyUp="@HandleMobileSearchKeyUp" />
        </div>
    </MudCollapse>
</MudAppBar>

<style>
    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        min-width: 300px;
    }
    
    .quick-action-item {
        padding: 12px;
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    
    .quick-action-item:hover {
        background-color: var(--ynex-gray-100);
    }
    
    .user-menu-header {
        background-color: var(--ynex-gray-50);
    }
    
    .mobile-search-bar {
        background-color: var(--ynex-header-bg);
        border-top: 1px solid var(--ynex-border-color);
    }
    
    /* Dark mode adjustments */
    [data-theme="dark"] .quick-action-item:hover {
        background-color: var(--ynex-gray-800);
    }
    
    [data-theme="dark"] .user-menu-header {
        background-color: var(--ynex-gray-800);
    }
    
    [data-theme="dark"] .mobile-search-bar {
        background-color: var(--ynex-header-bg);
    }
    
    .project-selector-button {
        max-width: 250px;
    }
    
    .project-selector-button .project-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 200px;
        display: inline-block;
    }
    
    .active-project-item {
        background-color: var(--mud-palette-warning-lighten) !important;
        border-left: 4px solid var(--mud-palette-warning);
    }
    
    .active-project-item:hover {
        background-color: var(--mud-palette-warning-lighten) !important;
    }
</style>

@code {
    [Parameter] public EventCallback OnToggleClick { get; set; }
    [Parameter] public EventCallback OnThemeToggle { get; set; }
    [Parameter] public bool IsDarkMode { get; set; }
    [Parameter] public string UserName { get; set; } = "Juan Pérez";
    [Parameter] public string UserEmail { get; set; } = "juan.perez@empresa.com";
    [Parameter] public string UserAvatar { get; set; } = "";
    [Parameter] public int NotificationCount { get; set; } = 3;
    [Parameter] public int MessageCount { get; set; } = 5;
    [Parameter] public EventCallback<string> OnSearchChanged { get; set; }
    [Parameter] public EventCallback OnNotificationsClick { get; set; }
    [Parameter] public EventCallback OnMessagesClick { get; set; }
    [Parameter] public EventCallback OnProfileClick { get; set; }
    [Parameter] public EventCallback OnSettingsClick { get; set; }
    [Parameter] public EventCallback OnLogoutClick { get; set; }
    [Parameter] public EventCallback<Guid> OnProjectChanged { get; set; }
    
    private string _searchText = "";
    private System.Timers.Timer? _debounceTimer;
    private bool _showMobileSearch = false;
    private bool _isFullScreen = false;
    
    // Project selector fields
    private List<ProjectListDto>? _projects;
    private List<ProjectTeamMemberDetailDto>? _userProjects;
    private ProjectTeamMemberDetailDto? _activeProject;
    private bool _loadingProjects = false;
    private Guid? _selectedProjectId;
    private string _selectedProjectName = "Sin proyecto";
    private string _userRole = "";
    private string _projectSearchText = "";
    
    private string SearchText
    {
        get => _searchText;
        set
        {
            if (_searchText != value)
            {
                _searchText = value;
                DebounceSearch();
            }
        }
    }

    private void ToggleMobileSearch()
    {
        _showMobileSearch = !_showMobileSearch;
    }

    private void HandleMobileSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            _showMobileSearch = false;
            _searchText = "";
        }
    }

    private async Task ToggleFullScreen()
    {
        _isFullScreen = !_isFullScreen;
        await JS.InvokeVoidAsync("eval", @"
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('Error attempting to enable fullscreen:', err);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        ");
    }
    
    private IEnumerable<ProjectTeamMemberDetailDto> FilteredUserProjects
    {
        get
        {
            if (_userProjects == null) return Enumerable.Empty<ProjectTeamMemberDetailDto>();
            
            if (string.IsNullOrWhiteSpace(_projectSearchText))
                return _userProjects;
            
            var searchTerm = _projectSearchText.ToLower();
            return _userProjects.Where(p => 
                p.ProjectName.ToLower().Contains(searchTerm) || 
                p.ProjectCode.ToLower().Contains(searchTerm));
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProjects();
    }

    private async Task LoadProjects()
    {
        try
        {
            _loadingProjects = true;
            
            // Obtener el ID del usuario actual
            var userId = await CurrentUserService.GetUserIdAsync();
            if (string.IsNullOrEmpty(userId) || !Guid.TryParse(userId, out var userGuid))
            {
                Logger.LogWarning("No se pudo obtener el ID del usuario actual");
                return;
            }
            
            // Cargar proyectos del usuario
            _userProjects = await TeamMemberService.GetUserProjectsAsync(userGuid) ?? new List<ProjectTeamMemberDetailDto>();
            Logger.LogDebug($"Usuario tiene {_userProjects.Count} proyectos asignados");
            
            if (_userProjects.Any())
            {
                // Identificar el proyecto activo
                _activeProject = _userProjects.FirstOrDefault(p => p.IsActive && p.StartDate <= DateTime.Today);
                
                // Seleccionar el proyecto activo o el primero disponible
                if (_activeProject != null)
                {
                    await SelectUserProject(_activeProject);
                }
                else if (!_selectedProjectId.HasValue)
                {
                    await SelectUserProject(_userProjects.First());
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar proyectos del usuario");
        }
        finally
        {
            _loadingProjects = false;
        }
    }

    private async Task SelectUserProject(ProjectTeamMemberDetailDto project)
    {
        _selectedProjectId = project.ProjectId;
        _selectedProjectName = project.ProjectName;
        _userRole = project.Role;
        
        // Store selected project in local storage
        await JS.InvokeVoidAsync("localStorage.setItem", "selectedProjectId", project.ProjectId.ToString());
        await JS.InvokeVoidAsync("localStorage.setItem", "selectedProjectName", project.ProjectName);
        await JS.InvokeVoidAsync("localStorage.setItem", "selectedProjectRole", project.Role);
        
        Logger.LogInfo($"Proyecto seleccionado: {project.ProjectName} ({project.ProjectId}) - Rol: {project.Role}");
        
        // Notify parent component about project change
        if (OnProjectChanged.HasDelegate)
        {
            await OnProjectChanged.InvokeAsync(project.ProjectId);
        }
        
        StateHasChanged();
    }
    
    private void NavigateTo(string url)
    {
        Navigation.NavigateTo(url);
    }
    
    private string GetUserInitials()
    {
        if (string.IsNullOrEmpty(UserName))
            return "U";
        
        var parts = UserName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        
        return UserName.Substring(0, Math.Min(2, UserName.Length)).ToUpper();
    }
    
    private Color GetRoleColor(string role) => SimplifiedRoles.GetProjectRoleLevel(role) switch
    {
        4 => Color.Error,      // Project Manager
        3 => Color.Warning,    // Team Lead
        2 => Color.Primary,    // Team Member
        1 => Color.Info,       // Viewer
        _ => Color.Default
    };
    
    private void DebounceSearch()
    {
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
        
        _debounceTimer = new System.Timers.Timer(300); // 300ms debounce
        _debounceTimer.Elapsed += async (sender, e) =>
        {
            _debounceTimer?.Dispose();
            if (OnSearchChanged.HasDelegate && !string.IsNullOrWhiteSpace(_searchText))
            {
                await InvokeAsync(async () =>
                {
                    await OnSearchChanged.InvokeAsync(_searchText);
                });
            }
        };
        _debounceTimer.AutoReset = false;
        _debounceTimer.Start();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Load saved project from local storage
            try
            {
                var savedProjectId = await JS.InvokeAsync<string>("localStorage.getItem", "selectedProjectId");
                var savedProjectName = await JS.InvokeAsync<string>("localStorage.getItem", "selectedProjectName");
                var savedProjectRole = await JS.InvokeAsync<string>("localStorage.getItem", "selectedProjectRole");
                
                if (!string.IsNullOrEmpty(savedProjectId) && Guid.TryParse(savedProjectId, out var projectId))
                {
                    _selectedProjectId = projectId;
                    _selectedProjectName = savedProjectName ?? "Sin proyecto";
                    _userRole = savedProjectRole ?? "";
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error al cargar proyecto guardado de localStorage");
            }
            
            // Listen for fullscreen changes
            await JS.InvokeVoidAsync("eval", @"
                document.addEventListener('fullscreenchange', () => {
                    DotNet.invokeMethodAsync('Web', 'OnFullScreenChange', !!document.fullscreenElement);
                });
            ");
        }
    }
    
    [JSInvokable]
    public static Task OnFullScreenChange(bool isFullScreen)
    {
        // This would need to be handled with a more complex pattern for instance methods
        return Task.CompletedTask;
    }
    
    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}